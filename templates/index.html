<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printer Expert Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f0f2f5;
            --bot-msg-bg: #ffffff;
            --user-msg-bg: #007bff;
        }
        body { background-color: var(--bg-color); height: 100vh; display: flex; flex-direction: column; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-y: auto; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px 0; min-height: 72px;position: sticky; top: 0; z-index: 1030;}
        .chat-container { flex: 1; overflow-y: visible; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; padding-bottom: 120px;}
        .welcome-card{ background:#f8f9fb; border:1px solid #e5e7eb; border-radius:16px; padding:14px 18px; max-width:460px; box-shadow:0 2px 6px rgba(0,0,0,.04);margin-top:16px; margin-left:6px}
        .chat-container .welcome-card{ margin-top:14px;}
        .chat-container.empty-state{justify-content:center;}
        .mode-badge{ cursor:pointer; transition:.15s ease; }
        .mode-badge:hover{ background:#e9f2ff !important; border-color:#cfe0ff;}

        .sm4-card { cursor: pointer; }
        .sm4-card:active { transform: translateY(0px); }

        /* Centered app column */
        .app-shell {  flex: 1;
  width: 100%;
  max-width: 980px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;}
        .navbar .container {max-width: 980px;}

        .message { max-width: 75%; padding: 12px 18px; border-radius: 18px; position: relative; font-size: 0.95rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .user-message { align-self: flex-end; background-color: var(--user-msg-bg); color: white; border-bottom-right-radius: 4px; }
        .bot-message { align-self: flex-start; background-color: var(--bot-msg-bg); color: #333; border-bottom-left-radius: 4px; }

        .message-content p:last-child { margin-bottom: 0; }
        .message-content ul, .message-content ol { padding-left: 20px; margin-bottom: 10px; }
        .message-content img { max-width: 100%; height: auto; border-radius: 10px; margin: 10px 0; display: block; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #eee; }

.input-area {
  padding: 12px 20px 25px 20px;
  width: 100%;

  background: transparent;
  border-top: none;
  box-shadow: none;

  position: sticky;
  bottom: 0;
  z-index: 1030;
}       .input-group { background: #f8f9fa; border-radius: 25px; padding: 10px 20px; border: 1px solid #ced4da; display: flex; align-items: center; gap: 8px;  box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
        .input-group input { border: none; background: transparent; padding: 10px; box-shadow: none !important; flex: 1; }
        .input-group button { border-radius: 50% !important; width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; }
        .input-group:focus-within {border-color: #2b60c3;box-shadow: 0 8px 24px rgba(0,123,255,0.15);}
        
        .typing { align-self: flex-start; background-color: var(--bot-msg-bg); padding: 12px 18px; border-radius: 18px; border-bottom-left-radius: 4px; display: none; }
        .dot { height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 3px; animation: jump 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes jump { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        /* SM4 result rendering */
        .sm4-header{font-weight:600;margin-bottom:8px;}
        .sm4-sub{font-size:.9rem;color:#555;margin-bottom:10px;}
        .sm4-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:10px;}
        .sm4-card{border:1px solid #eee;border-radius:12px;padding:8px;background:#fafafa;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .2s ease;}
        .sm4-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08);transform:translateY(-2px);}
        .sm4-card img{width:100%;max-width:200px;height:auto;object-fit:contain;margin-bottom:6px;}
        .sm4-title{font-size:.8rem;font-weight:600;line-height:1.2;margin-bottom:2px;}
        .sm4-caption{font-size:.75rem;color:#666;}
        .sm4-muted{font-size:.8rem;color:#666;}

        /* SM3 result rendering */
        .sm3-title { font-weight: 700; margin-bottom: 8px; }
        .sm3-pill { display: inline-block; padding: 3px 10px; border-radius: 999px; font-size: 0.85rem; margin-right: 6px; background: #f1f3f5; }
        .sm3-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .sm3-table th, .sm3-table td { border: 1px solid #eee; padding: 8px; vertical-align: top; }
        .sm3-table th { background: #fafafa; }
        .sm3-muted { font-size: 0.85rem; color: #666; margin-top: 8px; }
        .sm3-section-title { font-weight: 700; margin-top: 14px; }
        .sm3-small { font-size: 0.85rem; color: #555; }

        /* Quick suggestion chips */
        .qs-chip{border:1px solid #e5e7eb;background:#f8f9fb;border-radius:20px;padding:6px 10px;font-size:.85rem;line-height:1;cursor:pointer;transition:.15s ease;white-space:nowrap;}
        .qs-chip:hover{background:#e9f2ff;border-color:#cfe0ff;transform:translateY(-1px); box-shadow:0 2px 6px rgba(0,0,0,.08);}
        .qs-chip:active{transform:translateY(0);}.qs-wrap{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;margin-bottom:10px;align-items:center;scrollbar-width:thin;}
        .qs-wrap::-webkit-scrollbar{height:6px; margin-bottom:6px; margin-top:-6px;}
        #quickSuggestions, #quickSuggestionsLabel {transition: opacity .15s ease;}
        #qsBlock { overflow: hidden; transition: max-height .18s ease, opacity .15s ease, margin .18s ease; max-height: 120px; opacity: 1; margin-bottom: 10px; }
        #qsBlock.qs-hidden { max-height: 0; opacity: 0; margin-bottom: 0; }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-primary">
  <div class="container position-relative">
    <span class="navbar-brand mb-0 h1 position-absolute top-100 start-50 translate-middle">
      <i class="bi bi-printer-fill me-2"></i>Printer Expert Assistant
    </span>
  </div>
</nav>

<div class="app-shell">
<div class="chat-container" id="chatContainer">
  <div class="message bot-message welcome-card">
    <div class="message-content">
      <div style="font-weight:600;margin-bottom:6px;">Find the right printer fast.</div>

      <div class="sm4-muted" style="margin-bottom:10px;">Start by:</div>

      <span class="badge text-bg-light border mode-badge" onclick="triggerSM4()">üì∑ Find similar printers</span>
      <span class="badge text-bg-light border mode-badge" onclick="triggerSM3()">üß† Analyze reviews</span>

      <div class="sm4-muted" style="margin-top:10px;font-size:.8rem;">
        Or type what you need (e.g., ‚ÄúRecommend cheap Wi-Fi duplex printers‚Äù).
      </div>
    </div>
  </div>

  <div id="typingIndicator" class="typing">
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
  </div>
</div>

    <div class="input-area">
        <div id="qsBlock">
        <div id="quickSuggestionsLabel" class="sm4-muted" style="font-size:.8rem;margin-bottom:4px;">
            Quick suggestions:
        </div>

        <div id="quickSuggestions" class="qs-wrap">
            <button class="qs-chip" type="button" data-text="Recommend a cheap Wi-Fi duplex printer under $200">Recommend cheap Wi-Fi duplex printers</button>
            <button class="qs-chip" type="button" data-text="What printer is best for home use with low ink cost?">Printers with lowest ink cost</button>
            <button class="qs-chip" type="button" data-text="Compare Brother DCP-T830DW vs Epson EcoTank L8050">Compare printer models</button>
            <button class="qs-chip" type="button" data-text="Do you have A4 photo printers?">A4 photo printers</button>
            <button class="qs-chip" type="button" data-text="What toner should I buy for my HP printer?">Toner help</button>
        </div>
        </div>
            <div class="input-group">
                <!-- SM4 image picker (hidden) -->
                <input type="file" id="sm4File" accept="image/*" style="display:none" />

                <!-- SM4 icon button -->
                <button class="btn btn-outline-primary" type="button" id="sm4Btn" title="Visual Search">
                    <i class="bi bi-image"></i>
                </button>

                <!-- SM3 icon button -->
                <button class="btn btn-outline-primary" type="button" id="sm3Btn" title="Review Insights">
                    <i class="bi bi-journal-text"></i>
                </button>

                <!-- Text input -->
                <input type="text" id="userInput" class="form-control" placeholder="Ask about a printer..." autocomplete="off">

                <!-- Send chat -->
                <button class="btn btn-primary" type="button" id="sendBtn" title="Send">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>
</div>
    <!-- SM3 Modal -->
    <div class="modal fade" id="sm3Modal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">SM3 ‚Äî Customer Review Sentiment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2 text-muted" style="font-size:0.9rem;">
              Choose a printer model, paste <b>one review per line</b>. Submitting adds to that model‚Äôs saved history.
            </div>

            <!-- NEW: printer selector -->
            <div class="row g-2 align-items-center mb-2">
              <div class="col-12 col-md-8">
                <label class="form-label mb-1">Printer model</label>
                <select id="sm3Printer" class="form-select">
                  <option value="general">general</option>
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label mb-1">Saved reviews</label>
                <div class="form-control bg-light" id="sm3SavedCount">0</div>
              </div>
            </div>

            <textarea id="sm3Text" class="form-control" rows="8" placeholder="Amazing print quality...
Toner is too expensive...
Wi-Fi keeps disconnecting..."></textarea>

            <div class="d-flex gap-2 mt-3 flex-wrap">
              <button class="btn btn-primary" id="sm3AnalyzeBtn">
                <i class="bi bi-graph-up me-1"></i> Submit + Analyze
              </button>
              <button class="btn btn-outline-secondary" id="sm3AnalyzeOnlyBtn">
                Analyze saved
              </button>
              <button class="btn btn-outline-danger" id="sm3ClearSavedBtn">
                Clear saved for this printer
              </button>
              <button class="btn btn-outline-secondary" id="sm3ClearBtn">Clear textbox</button>
            </div>

            <div class="text-muted mt-2" id="sm3Status" style="font-size:0.85rem;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ SM4 Confirm Modal -->
<div class="modal fade" id="sm4Modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Visual Search (SM4)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="text-muted" style="font-size:0.9rem; margin-bottom:10px;">
          Confirm the image before searching.
        </div>

        <div class="text-center">
          <img id="sm4Preview" src="" alt="preview" style="max-width:100%; border-radius:12px; border:1px solid #eee;">
        </div>

        <div class="d-flex gap-2 mt-3 flex-wrap">
          <button class="btn btn-primary" id="sm4ConfirmBtn">
            <i class="bi bi-search me-1"></i> Search
          </button>

          <button class="btn btn-outline-secondary" id="sm4ChangeBtn">
            <i class="bi bi-arrow-repeat me-1"></i> Change image
          </button>

          <button class="btn btn-outline-danger" data-bs-dismiss="modal">
            Cancel
          </button>
        </div>

        <div class="text-muted mt-2" style="font-size:0.85rem;">
          Tip: You can also paste an image (Ctrl+V).
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SM4 Start Modal (shown when user clicks the icon) -->
<div class="modal fade" id="sm4StartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Visual Search</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="text-muted" style="font-size:0.9rem;">
          Choose how you want to provide the image.
        </div>

        <div class="d-flex gap-2 mt-3 flex-wrap">
          <button class="btn btn-primary" id="sm4StartUploadBtn">
            <i class="bi bi-upload me-1"></i> Upload image
          </button>

          <button class="btn btn-outline-secondary" id="sm4StartPasteBtn">
            <i class="bi bi-clipboard me-1"></i> Paste image (Ctrl+V)
          </button>

          <button class="btn btn-outline-danger" data-bs-dismiss="modal">
            Cancel
          </button>
        </div>

        <div class="text-muted mt-3" style="font-size:0.85rem;">
            Tip: After you upload/paste, you‚Äôll be asked to confirm the image before searching.
        </div>

        <div class="alert alert-light border mt-3 py-2" id="sm4PasteHint" style="display:none;">
            Now press <b>Ctrl+V</b> to paste a screenshot/image.
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ‚úÖ SM4 Result Details Modal -->
<div class="modal fade" id="sm4DetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">SM4 Result Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3 align-items-start">
          <div class="col-12 col-md-5 text-center">
            <img id="sm4DetailsImg" src="" alt="result"
                 style="max-width:100%; border-radius:12px; border:1px solid #eee;">
          </div>

          <div class="col-12 col-md-7">
            <div style="font-weight:700" id="sm4DetailsTitle"></div>
            <div class="text-muted mt-1" style="font-size:.9rem" id="sm4DetailsScore"></div>
            <div class="text-muted" style="font-size:.9rem" id="sm4DetailsLabel"></div>

            <div class="mt-3">
              <div class="fw-semibold">Detected features</div>
              <ul class="mt-2 mb-0" id="sm4DetailsFeatures" style="padding-left: 18px;"></ul>
              <div class="text-muted mt-2" style="font-size:.85rem" id="sm4DetailsHint"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let lastSm4Payload = null;

        const sm4DetailsModal = new bootstrap.Modal(document.getElementById("sm4DetailsModal"));
        const sm4DetailsImg = document.getElementById("sm4DetailsImg");
        const sm4DetailsTitle = document.getElementById("sm4DetailsTitle");
        const sm4DetailsScore = document.getElementById("sm4DetailsScore");
        const sm4DetailsLabel = document.getElementById("sm4DetailsLabel");
        const sm4DetailsFeatures = document.getElementById("sm4DetailsFeatures");
        const sm4DetailsHint = document.getElementById("sm4DetailsHint");

        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const typingIndicator = document.getElementById('typingIndicator');

        function openSm4Confirm(file) {
            pendingSm4File = file;

            // cleanup old preview URL
            if (pendingSm4PreviewUrl) {
                try { URL.revokeObjectURL(pendingSm4PreviewUrl); } catch (_) {}
            }
            pendingSm4PreviewUrl = URL.createObjectURL(file);
            sm4Preview.src = pendingSm4PreviewUrl;

            sm4Modal.show();
        }

        function closeSm4StartThenConfirm(file) {
        const startEl = document.getElementById("sm4StartModal");

        // If start modal isn't open, just open confirm directly
        if (!startEl || !startEl.classList.contains("show")) {
            openSm4Confirm(file);
            return;
        }

        // Wait for Bootstrap to finish closing before opening confirm
        const onHidden = () => {
            startEl.removeEventListener("hidden.bs.modal", onHidden);
            openSm4Confirm(file);
        };

        startEl.addEventListener("hidden.bs.modal", onHidden, { once: true });
        sm4StartModal.hide();
        }

        // SM4 controls
        const sm4Modal = new bootstrap.Modal(document.getElementById('sm4Modal'));
        const sm4Preview = document.getElementById('sm4Preview');
        const sm4ConfirmBtn = document.getElementById('sm4ConfirmBtn');
        const sm4ChangeBtn = document.getElementById('sm4ChangeBtn');
        const sm4Btn = document.getElementById('sm4Btn');
        const sm4File = document.getElementById('sm4File');
        const sm4StartModal = new bootstrap.Modal(document.getElementById('sm4StartModal'));
        const sm4StartUploadBtn = document.getElementById('sm4StartUploadBtn');
        const sm4StartPasteBtn = document.getElementById('sm4StartPasteBtn');
        const sm4PasteHint = document.getElementById('sm4PasteHint');

        let sm4PasteMode = false;
        let pendingSm4File = null;
        let pendingSm4PreviewUrl = null;

        // SM3 controls
        const sm3Btn = document.getElementById('sm3Btn');
        const sm3Modal = new bootstrap.Modal(document.getElementById('sm3Modal'));
        const sm3Text = document.getElementById('sm3Text');
        const sm3AnalyzeBtn = document.getElementById('sm3AnalyzeBtn');
        const sm3AnalyzeOnlyBtn = document.getElementById('sm3AnalyzeOnlyBtn');
        const sm3ClearSavedBtn = document.getElementById('sm3ClearSavedBtn');
        const sm3ClearBtn = document.getElementById('sm3ClearBtn');
        const sm3Status = document.getElementById('sm3Status');
        const sm3Printer = document.getElementById('sm3Printer');
        const sm3SavedCount = document.getElementById('sm3SavedCount');

        let chatHistory = [];

        function createMessageElement(role) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}-message`;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            msgDiv.appendChild(contentDiv);
            chatContainer.insertBefore(msgDiv, typingIndicator);
            return contentDiv;
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            userInput.value = '';

            // Render User Message
            const userContentDiv = createMessageElement('user');
            userContentDiv.textContent = message;
            chatHistory.push({ role: 'user', content: message });

            // Show typing indicator
            typingIndicator.style.display = 'block';
            scrollToBottom();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: chatHistory.slice(0, -1)
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                typingIndicator.style.display = 'none';
                const botContentDiv = createMessageElement('bot');
                let fullBotResponse = "";

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.text) {
                                    fullBotResponse += data.text;
                                    botContentDiv.innerHTML = marked.parse(fullBotResponse);
                                    scrollToBottom();
                                } else if (data.error) {
                                    botContentDiv.textContent = "Error: " + data.error;
                                }
                            } catch (e) {
                                console.error("Error parsing SSE data", e);
                            }
                        }
                    }
                }

                chatHistory.push({ role: 'assistant', content: fullBotResponse });

            } catch (error) {
                typingIndicator.style.display = 'none';
                const errorDiv = createMessageElement('bot');
                errorDiv.textContent = "Connection error. Please check your status.";
            }
            // hideSuggestionsOnceUsed()
        }

            function renderSm4Result(botDiv, data) {
            const pred = (data?.pred_class || "(no prediction)").trim();

            const bestMatch = (data?.best_match || "").trim();
            const matchLabel = (data?.match_label || "").trim();

            const queryFeatures = Array.isArray(data?.detected_features) ? data.detected_features : [];
            const selectedFeatures = Array.isArray(data?.selected_features) ? data.selected_features : [];

            const overview = data?.ai_overview || "";
            const results = Array.isArray(data?.results) ? data.results : [];

            let html = `
                <div class="sm4-header">üì∑ Visual Similarity Search (SM4)</div>
                <div class="sm4-sub"><strong>Prediction:</strong> ${escapeHtml(pred)}</div>
            `;

            // ‚úÖ show best match + label
            if (bestMatch) {
                html += `<div class="sm4-muted"><strong>Best match:</strong> ${escapeHtml(bestMatch)}</div>`;
            }
            if (matchLabel) {
                html += `<div class="sm4-muted"><strong>Match label:</strong> ${escapeHtml(matchLabel)}</div>`;
            }

            // ‚úÖ show detected features (query + selected)
            if (queryFeatures.length) {
                html += `<div class="sm4-muted mt-2"><strong>Query features:</strong> ${escapeHtml(queryFeatures.join(" ¬∑ "))}</div>`;
            }
            if (selectedFeatures.length) {
                html += `<div class="sm4-muted"><strong>Selected product features:</strong> ${escapeHtml(selectedFeatures.join(" ¬∑ "))}</div>`;
            }

            // ‚úÖ results grid
            if (results.length > 0) {
            html += `<div class="sm4-muted mt-2"><strong>Top matches:</strong></div>`;
            html += `<div class="sm4-grid">`;

            results.slice(0, 5).forEach((r, i) => {
                const title = String(r?.Product_Title || "Result").trim();
                const imgUrl = r?.image_url || "";

                const parts = title.split("\n");
                const titleLine = (parts[0] || "Result").trim();
                const scoreLine = (parts.find(x => x.toLowerCase().includes("score:")) || "").trim();

                html += `<div class="sm4-card" data-sm4-index="${i}">`;

                if (imgUrl) {
                html += `<img src="${escapeAttr(imgUrl)}" alt="result image" />`;
                } else {
                html += `<div class="sm4-muted">Image preview unavailable</div>`;
                }

                html += `<div class="sm4-title">${escapeHtml(titleLine)}</div>`;
                if (scoreLine) html += `<div class="sm4-caption">${escapeHtml(scoreLine)}</div>`;
                html += `</div>`;
            });

            html += `</div>`;
            } else {
            html += `<div class="sm4-muted">No results returned.</div>`;
            }

            // ‚úÖ explanation (markdown)
            if (overview) {
                html += `<div class="mt-3"><strong>AI Explanation:</strong></div>`;
                html += `<div class="mt-2">${marked.parse(overview)}</div>`;
            }

            botDiv.innerHTML = html;

            lastSm4Payload = data; // store first so click can use it

            // ‚úÖ Make cards clickable -> open details modal
            botDiv.querySelectorAll(".sm4-card").forEach(card => {
            card.addEventListener("click", () => {
                const idx = parseInt(card.getAttribute("data-sm4-index"), 10);
                if (!Number.isNaN(idx)) openSm4Details(idx);
            });
            });

            updateQuickSuggestionsForSM4(data);
            }

        function renderTable(headers, rows) {
            let html = `<table class="sm3-table"><thead><tr>`;
            for (const h of headers) html += `<th>${escapeHtml(h)}</th>`;
            html += `</tr></thead><tbody>`;
            for (const r of rows) {
                html += `<tr>`;
                for (const cell of r) html += `<td>${escapeHtml(cell)}</td>`;
                html += `</tr>`;
            }
            html += `</tbody></table>`;
            return html;
        }

        function renderSm3Result(botDiv, payload) {
            const printerId = payload?.printer_id || "general";
            const savedCount = payload?.saved_count ?? 0;

            const overall = payload?.overall || "";
            const rows = Array.isArray(payload?.rows) ? payload.rows : [];
            const love = Array.isArray(payload?.what_users_love) ? payload.what_users_love : [];
            const concerns = Array.isArray(payload?.common_concerns) ? payload.common_concerns : [];
            const features = Array.isArray(payload?.feature_ratings) ? payload.feature_ratings : [];
            const insights = (payload?.insights || "").trim();

            let html = `<div class="sm3-title">üìù SM3 ‚Äî Review Sentiment (${escapeHtml(printerId)})</div>`;
            html += `<div class="sm3-small">Saved reviews for this printer: <b>${escapeHtml(savedCount)}</b></div>`;

            if (overall) {
                html += `<div class="mt-2">${escapeHtml(overall)}</div>`;
            }

            // per-review summary pills
            const pos = rows.filter(r => String(r.sentiment || "").toLowerCase() === "positive").length;
            const neg = rows.filter(r => String(r.sentiment || "").toLowerCase() === "negative").length;
            const total = rows.length;

            if (total > 0) {
                html += `
                    <div class="mt-2">
                        <span class="sm3-pill">Positive: ${pos} (${(pos/total*100).toFixed(1)}%)</span>
                        <span class="sm3-pill">Negative: ${neg} (${(neg/total*100).toFixed(1)}%)</span>
                        <span class="sm3-pill">Total: ${total}</span>
                    </div>
                `;
            }

            // What users love / concerns (theme tables)
            if (love.length > 0) {
                html += `<div class="sm3-section-title">What Users Love</div>`;
                const trows = love.map(x => [x.theme, String(x["positive_%"]), String(x.mentions)]);
                html += renderTable(["theme", "positive_%", "mentions"], trows);
            }

            if (concerns.length > 0) {
                html += `<div class="sm3-section-title">Common Concerns</div>`;
                const trows = concerns.map(x => [x.theme, String(x["negative_%"]), String(x.mentions)]);
                html += renderTable(["theme", "negative_%", "mentions"], trows);
            }

            // Feature ratings
            if (features.length > 0) {
                html += `<div class="sm3-section-title">Feature Ratings (keyword-based)</div>`;
                const frows = features.map(x => [
                    x.feature,
                    String(x.mentions),
                    String(x["positive_%"]),
                    String(x["negative_%"]),
                    String(x.avg_conf),
                    String(x.rating_1to5)
                ]);
                html += renderTable(["feature", "mentions", "positive_%", "negative_%", "avg_conf", "rating_1to5"], frows);
            }

            // Per-review table (first 20)
            if (rows.length > 0) {
                html += `<div class="sm3-section-title">Per review results</div>`;
                const pr = rows.slice(0, 20).map(r => [r.review || "", r.sentiment || "", String(r.confidence ?? "")]);
                html += renderTable(["review", "sentiment", "confidence"], pr);
                if (rows.length > 20) {
                    html += `<div class="sm3-muted">Showing first 20 rows. (${rows.length} total)</div>`;
                }
            } else {
                html += `<div class="sm3-muted mt-2">No per-review rows returned.</div>`;
            }

            // optional insights (if your HF space returns something meaningful)
            if (insights) {
                html += `<div class="sm3-section-title">AI Insights</div>`;
                html += `<div class="mt-2">${marked.parse(insights)}</div>`;
            }

            botDiv.innerHTML = html;
        }

        function escapeHtml(str) {
            return String(str ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function escapeAttr(str) {
            return escapeHtml(str).replaceAll("`", "&#096;");
        }

        async function sendImage(file) {
            if (!file) return;

            const userDiv = createMessageElement('user');
            const previewUrl = URL.createObjectURL(file);
            userDiv.innerHTML = `<div><strong>üì∑ Image sent</strong></div><img src="${previewUrl}" alt="uploaded image" />`;

            typingIndicator.style.display = 'block';
            scrollToBottom();

            try {
                const form = new FormData();
                form.append("image", file);

                const res = await fetch('/api/search', {
                    method: 'POST',
                    body: form
                });

                const data = await res.json();
                typingIndicator.style.display = 'none';

                const botDiv = createMessageElement('bot');

                if (!res.ok || !data.ok) {
                    const msg = data?.error || "Visual search failed.";
                    botDiv.textContent = "Error: " + msg;
                    return;
                }

                renderSm4Result(botDiv, data);
                scrollToBottom();

            } catch (err) {
                typingIndicator.style.display = 'none';
                const botDiv = createMessageElement('bot');
                botDiv.textContent = "Error: " + err.message;
            } finally {
                try { URL.revokeObjectURL(previewUrl); } catch (_) {}
            }
        }

        async function sm3RefreshStatus() {
            const pid = (sm3Printer.value || "general").trim();
            try {
                const res = await fetch('/api/sm3', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: "status", printer_id: pid })
                });
                const data = await res.json();
                if (data?.ok) {
                    sm3SavedCount.textContent = String(data.saved_count ?? 0);
                }
            } catch (_) {}
        }

        async function sm3LoadPrinters() {
            try {
                const res = await fetch('/api/printers');
                const data = await res.json();
                if (!data?.ok) return;
                const items = Array.isArray(data.printers) ? data.printers : ["general"];

                // rebuild options (keep current selection if possible)
                const current = sm3Printer.value || "general";
                sm3Printer.innerHTML = "";
                for (const p of items) {
                    const opt = document.createElement("option");
                    opt.value = p;
                    opt.textContent = p;
                    sm3Printer.appendChild(opt);
                }
                sm3Printer.value = items.includes(current) ? current : "general";
                await sm3RefreshStatus();
            } catch (e) {
                console.error(e);
            }
        }

        async function runSm3SubmitAndAnalyze() {
            const text = (sm3Text.value || "").trim();
            if (!text) return;

            const pid = (sm3Printer.value || "general").trim();

            sm3Status.textContent = "Submitting + analyzing...";
            sm3AnalyzeBtn.disabled = true;
            sm3AnalyzeOnlyBtn.disabled = true;
            sm3ClearSavedBtn.disabled = true;

            // Show in chat as a user action (no huge wall)
            const count = text.split('\n').filter(x=>x.trim()).length;
            const userDiv = createMessageElement('user');
            userDiv.innerHTML = `<div><strong>üìù Analyze reviews</strong></div>
                                 <div class="sm3-muted">Printer: ${escapeHtml(pid)} ¬∑ Added: ${count}</div>`;

            typingIndicator.style.display = 'block';
            scrollToBottom();

            try {
                const res = await fetch('/api/sm3', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: "submit",
                        printer_id: pid,
                        reviews: text
                    })
                });

                const data = await res.json();
                typingIndicator.style.display = 'none';

                const botDiv = createMessageElement('bot');

                if (!res.ok || !data.ok) {
                    botDiv.textContent = "SM3 error: " + (data?.error || "Unknown error");
                } else {
                    renderSm3Result(botDiv, data);
                    sm3SavedCount.textContent = String(data.saved_count ?? 0);
                }

                scrollToBottom();
                sm3Status.textContent = "";
                sm3Modal.hide();

            } catch (e) {
                typingIndicator.style.display = 'none';
                const botDiv = createMessageElement('bot');
                botDiv.textContent = "SM3 connection error.";
                sm3Status.textContent = "";
            } finally {
                sm3AnalyzeBtn.disabled = false;
                sm3AnalyzeOnlyBtn.disabled = false;
                sm3ClearSavedBtn.disabled = false;
            }
        }

        async function runSm3AnalyzeSaved() {
            const pid = (sm3Printer.value || "general").trim();

            sm3Status.textContent = "Analyzing saved reviews...";
            sm3AnalyzeBtn.disabled = true;
            sm3AnalyzeOnlyBtn.disabled = true;
            sm3ClearSavedBtn.disabled = true;

            const userDiv = createMessageElement('user');
            userDiv.innerHTML = `<div><strong>üìù Analyze saved reviews</strong></div>
                                 <div class="sm3-muted">Printer: ${escapeHtml(pid)}</div>`;

            typingIndicator.style.display = 'block';
            scrollToBottom();

            try {
                const res = await fetch('/api/sm3', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: "analyze",
                        printer_id: pid
                    })
                });

                const data = await res.json();
                typingIndicator.style.display = 'none';

                const botDiv = createMessageElement('bot');

                if (!res.ok || !data.ok) {
                    botDiv.textContent = "SM3 error: " + (data?.error || "Unknown error");
                } else {
                    renderSm3Result(botDiv, data);
                    sm3SavedCount.textContent = String(data.saved_count ?? 0);
                }

                scrollToBottom();
                sm3Status.textContent = "";
                sm3Modal.hide();

            } catch (e) {
                typingIndicator.style.display = 'none';
                const botDiv = createMessageElement('bot');
                botDiv.textContent = "SM3 connection error.";
                sm3Status.textContent = "";
            } finally {
                sm3AnalyzeBtn.disabled = false;
                sm3AnalyzeOnlyBtn.disabled = false;
                sm3ClearSavedBtn.disabled = false;
            }
        }

        async function runSm3ClearSaved() {
            const pid = (sm3Printer.value || "general").trim();
            sm3Status.textContent = "Clearing saved reviews...";
            sm3ClearSavedBtn.disabled = true;

            try {
                const res = await fetch('/api/sm3', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: "clear",
                        printer_id: pid
                    })
                });

                const data = await res.json();
                if (data?.ok) {
                    sm3SavedCount.textContent = "0";
                    sm3Status.textContent = `Cleared saved reviews for "${pid}".`;
                } else {
                    sm3Status.textContent = "Clear failed: " + (data?.error || "Unknown error");
                }
            } catch (e) {
                sm3Status.textContent = "Clear failed: connection error.";
            } finally {
                sm3ClearSavedBtn.disabled = false;
            }
        }

        // Events
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // SM4 icon triggers file picker
        sm4Btn.addEventListener('click', () => {
        sm4PasteMode = false;
        if (sm4PasteHint) sm4PasteHint.style.display = "none";
        sm4StartModal.show();
        });      

        sm4File.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        e.target.value = "";
        if (file) openSm4Confirm(file);
        });

        sm4StartUploadBtn.addEventListener("click", () => {
        sm4PasteMode = false;
        if (sm4PasteHint) sm4PasteHint.style.display = "none";

        const startEl = document.getElementById("sm4StartModal");
        startEl.addEventListener("hidden.bs.modal", () => sm4File.click(), { once: true });
        sm4StartModal.hide();
        });

        sm4StartPasteBtn.addEventListener("click", () => {
        sm4PasteMode = true;
        if (sm4PasteHint) sm4PasteHint.style.display = "block";
        });

        // Paste-to-upload for SM4 (Ctrl+V screenshot / copied image)
        document.addEventListener("paste", (e) => {
        const items = (e.clipboardData && e.clipboardData.items) ? e.clipboardData.items : [];
        for (const item of items) {
            if (item.type && item.type.startsWith("image/")) {
            const file = item.getAsFile();
            if (file) {
                sm4PasteMode = false;
                if (sm4PasteHint) sm4PasteHint.style.display = "none";

                // ‚úÖ Close start modal first, then show confirm modal
                closeSm4StartThenConfirm(file);

                e.preventDefault();
                return;
            }
            }
        }
        });

        sm4ConfirmBtn.addEventListener("click", async () => {
  if (!pendingSm4File) return;
  sm4Modal.hide();
  await sendImage(pendingSm4File);
});

sm4ChangeBtn.addEventListener("click", () => {
  // reopen file picker
  sm4File.click();
});

        // SM3 modal open
        sm3Btn.addEventListener('click', async () => {
            sm3Status.textContent = "";
            await sm3LoadPrinters();
            sm3Modal.show();
        });

        sm3Printer.addEventListener('change', sm3RefreshStatus);

        // SM3 modal buttons
        sm3AnalyzeBtn.addEventListener('click', runSm3SubmitAndAnalyze);
        sm3AnalyzeOnlyBtn.addEventListener('click', runSm3AnalyzeSaved);
        sm3ClearSavedBtn.addEventListener('click', runSm3ClearSaved);
        sm3ClearBtn.addEventListener('click', () => sm3Text.value = "");

        function triggerSM4(){
            document.getElementById("sm4Btn").click();
        }

        function triggerSM3(){
            document.getElementById("sm3Btn").click();
        }

        // Quick Suggestions: click to fill input (Shift-click to send immediately)
        document.addEventListener("click", (e) => {
        const chip = e.target.closest(".qs-chip");
        if (!chip) return;

        const text = (chip.getAttribute("data-text") || chip.textContent || "").trim();
        if (!text) return;

        userInput.value = text;
        userInput.focus();
        // syncQuickSuggestionsVisibility();

        // Optional: Shift+click sends immediately
        if (e.shiftKey) sendMessage();
        });
        function setQuickSuggestions(items) {
            const wrap = document.getElementById("quickSuggestions");
            if (!wrap) return;
            wrap.innerHTML = "";
            for (const it of items.slice(0, 6)) {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "qs-chip";
                btn.setAttribute("data-text", it.text);
                btn.textContent = it.label;
                wrap.appendChild(btn);
        }
}

            function updateQuickSuggestionsForSM4(data) {
            const results = Array.isArray(data?.results) ? data.results : [];

            // Titles may include "\nScore: ..."
            const topTitles = results
                .slice(0, 2)
                .map(r => String(r?.Product_Title || "").split("\n")[0].trim())
                .filter(Boolean);

            const items = [
                { label: "Cheapest match?", text: "Which of these matches is the cheapest? Show prices." },
                { label: "Best for home", text: "Which match is best for home use and low running cost?" },
            ];

            if (topTitles.length === 2) {
                items.unshift({
                label: "Compare top 2",
                text: `Compare ${topTitles[0]} vs ${topTitles[1]} for features and value.`
                });
            }

            setQuickSuggestions(items);
            }
        function hideSuggestionsOnceUsed(){
            const wrap = document.getElementById("quickSuggestions");
            if (wrap) wrap.style.display = "none";
}
// Sync quick suggestions visibility based on input content
// Quick suggestions show ONLY when input is focused AND empty
const qsBlock = document.getElementById("qsBlock");
if (qsBlock) {
  qsBlock.addEventListener("mousedown", (e) => {
    e.preventDefault(); // keeps focus on input while clicking chips
  });
}
function syncQuickSuggestionsVisibility() {
  if (!qsBlock) return;

  const isFocused = document.activeElement === userInput;
  const hasText = userInput.value.trim().length > 0;

  // show only when focused and empty
  const hide = !isFocused || hasText;

  qsBlock.classList.toggle("qs-hidden", hide);
}

userInput.addEventListener("focus", syncQuickSuggestionsVisibility);
userInput.addEventListener("blur", syncQuickSuggestionsVisibility);
userInput.addEventListener("input", syncQuickSuggestionsVisibility);

syncQuickSuggestionsVisibility();

function openSm4Details(index) {
  if (!lastSm4Payload) return;

  const results = Array.isArray(lastSm4Payload.results) ? lastSm4Payload.results : [];
  const r = results[index];
  if (!r) return;

  // Title + score
  const rawTitle = String(r.Product_Title || "Result");
  const parts = rawTitle.split("\n").map(x => x.trim()).filter(Boolean);
  const titleLine = parts[0] || "Result";
  const scoreLine = parts.find(x => x.toLowerCase().includes("score:")) || "";

  sm4DetailsTitle.textContent = titleLine;
  sm4DetailsScore.textContent = scoreLine;

  // Match label (per-item preferred)
  const label = String(r.match_label || "").trim();
  sm4DetailsLabel.textContent = label ? `Match label: ${label}` : "";

  // Image
  const imgUrl = r.image_url || "";
  sm4DetailsImg.src = imgUrl ? imgUrl : "";
  sm4DetailsImg.style.display = imgUrl ? "block" : "none";

  // Detected features (ONLY show if backend provided per-item features)
  const feats = Array.isArray(r.detected_features) ? r.detected_features : [];

  sm4DetailsFeatures.innerHTML = "";

  if (feats.length > 0) {
    feats.forEach(f => {
      const li = document.createElement("li");
      li.textContent = String(f);
      sm4DetailsFeatures.appendChild(li);
    });
    sm4DetailsHint.textContent = "";
  } else {
    sm4DetailsHint.textContent = "Detected features are only available for the selected product (from SM4).";
  }

  sm4DetailsModal.show();
}
    </script>
</body>
</html>